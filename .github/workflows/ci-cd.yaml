name: CI CD pipeline

on:
  pull_request:
    types: [closed]
    

jobs:
  build:
    name: build and push docker image
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      
      - name: Bump version and push tag
        id: tag
        uses: anothrNick/github-tag-action@1.64.0 
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_GITHUB }} 
          DEFAULT_BUMP: patch
          WITH_V: false
          INITIAL_VERSION: 1.0.0
      - name: Build the Docker image and tag
        run: |
          docker build . --file Dockerfile --tag app:${{ steps.tag.outputs.new_tag }}
          docker tag app:${{ steps.tag.outputs.new_tag }} ofekmalul/web_app:${{ steps.tag.outputs.new_tag }}

      - name: Log in to DockerHub
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Push to dockerhub
        run: docker push ofekmalul/web_app:${{ steps.tag.outputs.new_tag }}

  deploy:
     name: deploy helm chart to eks
     runs-on: ubuntu-latest

     steps:
       - name: configure AWS credentials
         uses: aws-actions/configure-aws-credentials@v4
         with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: us-east-1

        # This command aws eks update kubeconfig will retrive the .kube file from eks so it can connect to the eks
       - name: Authenticate with EKS
         run: aws eks update-kubeconfig --name terraform-eks-cluster --region us-east-1

       - name: update Helm chart
        #  run: sed -i 's/tag: "1.0.0"/tag: "${{ steps.tag.outputs.new_tag }}"/g' weather_app_chart/values.yaml
         run: |
            sed -i "s/tag: \"1.0.0\"/tag: \"${{ steps.tag.outputs.new_tag }}\"/g" weather_app_chart/values.yaml
         
       - name: Deploy Helm chart
         run: helm upgrade --install web_app weather_app_chart/